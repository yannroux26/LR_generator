{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="settings-form">
  <h1>Parameters</h1>
  {% if saved %}
    <div class="success">Parameters saved!</div>
  {% endif %}
  <!-- Character limits form -->
  <form method="post" id="char-limits-form">
    {% csrf_token %}
    <input type="hidden" name="char_limits_save" value="1">
    <fieldset>
      <legend>Character limits per section</legend>
      <label>Research Question:
        <input type="number" name="research_question" value="{{ nbchar.research_question }}" min="100" max="20000" step="100" required>
      </label>
      <label>Methodology:
        <input type="number" name="methodology" value="{{ nbchar.methodology }}" min="100" max="20000" step="100" required>
      </label>
      <label>Findings:
        <input type="number" name="findings" value="{{ nbchar.findings }}" min="100" max="20000" step="100" required>
      </label>
      <label>Gaps:
        <input type="number" name="gaps" value="{{ nbchar.gaps }}" min="100" max="20000" step="100" required>
      </label>
      <div style="margin-top:1rem;">
        <button type="submit" class="generate-btn">Save</button>
        <button type="button" id="reset-char-btn">Reset</button>
      </div>
    </fieldset>
  </form>

  <!-- Token limits form -->
  <form method="post" id="token-limits-form">
    {% csrf_token %}
    <input type="hidden" name="token_limits_save" value="1">
    <fieldset>
      <legend>Token limits</legend>
      <label>Max tokens to compose the review:
        <input type="number" id="max_tokens_compose" name="max_tokens_compose" value="{{ max_tokens_compose }}" min="100" max="4000" step="50" required>
      </label>
      <label>Max tokens to edit the review:
        <input type="number" id="max_tokens_edit" name="max_tokens_edit" value="{{ max_tokens_edit }}" min="100" max="4000" step="50" required>
      </label>
      <div id="max-token-msg">
        <em>Note: The max tokens to edit the review must be greater or equal to the max tokens to compose the review.</em>
      </div>
      <div style="margin-top:1rem;">
        <button type="submit" class="generate-btn">Save</button>
        <button type="button" id="reset-token-btn">Reset</button>
      </div>
    </fieldset>
  </form>

  <!-- Writing Style section -->
  <fieldset style="margin-top:2rem;">
    <legend>Writing Style</legend>
    <div style="margin-top:1rem;">
      <form id="writing-style-upload-form" method="post" enctype="multipart/form-data" style="margin-bottom:1rem;">
        {% csrf_token %}
        <input type="hidden" name="writing_file_upload" value="1">
        <input type="file" name="writing_file" id="writing_file_input" accept="application/pdf" multiple required>
        <button type="submit">Upload</button>
      </form>
      <div id="writing-style-files-list" style="margin-top:0.5rem;">
        <strong>Uploaded files:</strong>
        <ul>
          {% for file in writing_files %}
            <li>{{ file.original_name }}
              <form method="post" action="{% url 'rag_app:delete_writing_file' file.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" style="color:red;">Delete</button>
              </form>
            </li>
          {% empty %}
            <li>No writing style files uploaded.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </fieldset>
  <script>
    // Ensure max_tokens_edit >= max_tokens_compose
    const composeInput = document.getElementById('max_tokens_compose');
    const editInput = document.getElementById('max_tokens_edit');
    // Character limits reset
    const charForm = document.getElementById('char-limits-form');
    const resetCharBtn = document.getElementById('reset-char-btn');
    resetCharBtn.addEventListener('click', function() {
      charForm.research_question.value = 5000;
      charForm.methodology.value = 5000;
      charForm.findings.value = 5000;
      charForm.gaps.value = 5000;
    });

    // Token limits validation and reset
    const tokenForm = document.getElementById('token-limits-form');
    const composeInput = document.getElementById('max_tokens_compose');
    const editInput = document.getElementById('max_tokens_edit');
    const resetTokenBtn = document.getElementById('reset-token-btn');
    tokenForm.addEventListener('submit', function(e) {
      const composeVal = parseInt(composeInput.value, 10);
      const editVal = parseInt(editInput.value, 10);
      if (editVal < composeVal) {
        alert('max_tokens to edit the review must be greater than or equal to max_tokens to compose the review.');
        editInput.focus();
        e.preventDefault();
      }
    });
    composeInput.addEventListener('input', function() {
      if (parseInt(editInput.value, 10) < parseInt(composeInput.value, 10)) {
        editInput.value = composeInput.value;
      }
      editInput.min = composeInput.value;
    });
    resetTokenBtn.addEventListener('click', function() {
      tokenForm.max_tokens_compose.value = 1500;
      tokenForm.max_tokens_edit.value = 1500;
      editInput.min = 1500;
    });

    // Writing style reset (clears file input)
    const resetWritingBtn = document.getElementById('reset-writing-btn');
    const writingFileInput = document.getElementById('writing_file_input');
    resetWritingBtn.addEventListener('click', function() {
      writingFileInput.value = '';
    });
  </script>
  </form>
</div>
{% endblock %}
