{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="settings-form">
  <h1>Parameters</h1>
  {% if saved %}
    <div class="success">Parameters saved!</div>
  {% endif %}
  <form method="post">
    {% csrf_token %}
    <fieldset>
      <legend>Character limits per section</legend>
      <label>Research Question:
        <input type="number" name="research_question" value="{{ nbchar.research_question }}" min="100" max="20000" step="100" required>
      </label>
      <label>Methodology:
        <input type="number" name="methodology" value="{{ nbchar.methodology }}" min="100" max="20000" step="100" required>
      </label>
      <label>Findings:
        <input type="number" name="findings" value="{{ nbchar.findings }}" min="100" max="20000" step="100" required>
      </label>
      <label>Gaps:
        <input type="number" name="gaps" value="{{ nbchar.gaps }}" min="100" max="20000" step="100" required>
      </label>
    </fieldset>
    <fieldset>
      <legend>Token limits</legend>
      <label>Max tokens to compose the review:
        <input type="number" id="max_tokens_compose" name="max_tokens_compose" value="{{ max_tokens_compose }}" min="100" max="4000" step="50" required>
      </label>
      <label>Max tokens to edit the review:
        <input type="number" id="max_tokens_edit" name="max_tokens_edit" value="{{ max_tokens_edit }}" min="100" max="4000" step="50" required>
      </label>
      <div id="max-token-msg">
        <em>Note: The max tokens to edit the review must be greater or equal to the max tokens to compose the review.</em>
      </div>
    </fieldset>
    <button type="submit" class="generate-btn">Save</button>
    <button type="button" id="reset-btn">Reset</button>
  </form>
  <script>
    // Ensure max_tokens_edit >= max_tokens_compose
    const composeInput = document.getElementById('max_tokens_compose');
    const editInput = document.getElementById('max_tokens_edit');
    const form = document.querySelector('form');
    const resetBtn = document.getElementById('reset-btn');
    // Default values
    const defaults = {
      research_question: 5000,
      methodology: 5000,
      findings: 5000,
      gaps: 5000,
      max_tokens_compose: 1500,
      max_tokens_edit: 1500
    };
    form.addEventListener('submit', function(e) {
      const composeVal = parseInt(composeInput.value, 10);
      const editVal = parseInt(editInput.value, 10);
      if (editVal < composeVal) {
        alert('max_tokens to edit the review must be greater than or equal to max_tokens to compose the review.');
        editInput.focus();
        e.preventDefault();
      }
    });
    // Optionally, auto-correct on input
    composeInput.addEventListener('input', function() {
      if (parseInt(editInput.value, 10) < parseInt(composeInput.value, 10)) {
        editInput.value = composeInput.value;
      }
      editInput.min = composeInput.value;
    });
    // Custom reset: set all fields to default values
    resetBtn.addEventListener('click', function() {
      form.research_question.value = defaults.research_question;
      form.methodology.value = defaults.methodology;
      form.findings.value = defaults.findings;
      form.gaps.value = defaults.gaps;
      form.max_tokens_compose.value = defaults.max_tokens_compose;
      form.max_tokens_edit.value = defaults.max_tokens_edit;
      editInput.min = defaults.max_tokens_compose;
    });
  </script>
  </form>
</div>
{% endblock %}
